---

- name: Security hardening
  hosts: overcloud
  become: true
  tasks:
    # TODO: Remove this when Red Hat FIPS policy has been updated to allow ed25519 keys.
    # https://gitlab.com/gitlab-org/gitlab/-/issues/367429#note_1840422075
    - when: ansible_facts.os_family == 'RedHat'
      block:
       - name: Check type of key using the file command
         raw: file {{ ssh_private_key_path }}
         delegate_to: localhost
         changed_when: false
         register: ssh_key_check

       - name: Assert that we are using a supported SSH key
         assert:
            that:
              - ssh_key_check.stdout | regex_search('ed25519', ignorecase=true)
            fail_msg: FIPS policy does not currently support ed25519 SSH keys on RHEL family systems

    - name: Ensure the cron package is installed on ubuntu
      package:
        name: cron
        state: present
      when: ansible_facts.distribution == 'Ubuntu'

    - include_role:
        name: ansible-lockdown.rhel9_cis
      when: ansible_facts.os_family == 'RedHat' and ansible_facts.distribution_major_version == '9'
      tags: always

    - include_role:
        name: ansible-lockdown.ubuntu22_cis
      when: ansible_facts.distribution == 'Ubuntu' and ansible_facts.distribution_major_version == '22'
      tags: always
