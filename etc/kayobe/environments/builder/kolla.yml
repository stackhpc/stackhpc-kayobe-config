---
# Kayobe Kolla configuration.

###############################################################################
# Kolla configuration.

# Docker tag applied to built container images. Default is
# {{ kolla_openstack_release }}.
kolla_tag: >-
        {{ openstack_release }}-{{- lookup('env', 'KOLLA_IMAGE_VERSION ')
        | default(ansible_facts.date_time.iso8601_basic_short, true) -}}
        {{ ('-' ~ kolla_tag_suffix) if kolla_tag_suffix is defined else '' }}

# Docker namespace to use for Kolla images. Default is 'kolla'.
kolla_docker_namespace: scientific-openstack/infrastructure/kayobe-config

# List of repositories for CentOS Stream.
stackhpc_centos_stream_repos:
  - url: "{{ stackhpc_repo_centos_stream_baseos_url }}"
    file: "CentOS-Stream-BaseOS.repo"
  - url: "{{ stackhpc_repo_centos_stream_appstream_url }}"
    file: "CentOS-Stream-AppStream.repo"
  - url: "{{ stackhpc_repo_centos_stream_extras_url }}"
    file: "CentOS-Stream-Extras.repo"

# List of repositories for EPEL.
stackhpc_epel_repos:
  - url: "{{ stackhpc_repo_epel_url }}"
    file: "epel.repo"
  - url: "{{ stackhpc_repo_epel_modular_url }}"
    file: "epel-modular.repo"

# List of additional CentOS Stream repositories.
stackhpc_centos_additional_repos:
  # Snapshots install broken repo file, so hardcode to one that works.
  - url: "{{ stackhpc_repo_centos_storage_ceph_nautilus_url }}"
    file: CentOS-Ceph-Nautilus.repo
  - url: "{{ stackhpc_repo_centos_stream_powertools_url }}"
    file: "CentOS-Stream-PowerTools.repo"
  - url: "{{ stackhpc_repo_centos_opstools_url }}"
    file: "CentOS-OpsTools.repo"

# List of third-party repositories.
stackhpc_third_party_repos: []

kolla_build_blocks:
  base_header: |
    RUN \
    {% for repo in stackhpc_centos_stream_repos %}
        sed -i -e 's/^\(mirrorlist *=.*\)/#\1/g' \
               -e 's/^[# ]*\(baseurl *=.*\)/#\1/g' \
               -e '/#baseurl.*/a baseurl={{ repo.url }}' /etc/yum.repos.d/{{ repo.file }}{% if not loop.last %} && \
    {% endif %}
    {% endfor %}
  base_centos_repo_overrides_post_yum: |
    {# fixme #}
        && \
    {% for repo in stackhpc_centos_stream_repos + stackhpc_epel_repos + stackhpc_centos_additional_repos + stackhpc_third_party_repos %}
        sed -i -e 's/^\(mirrorlist *=.*\)/#\1/g' \
               -e 's/^[# ]*\(baseurl *=.*\)/#\1/g' \
               -e '/#baseurl.*/a baseurl={{ repo.url }}' /etc/yum.repos.d/{{ repo.file }}{% if not loop.last %} &&{% endif %} \
    {% endfor %}
  bifrost_footer: |
    RUN /var/lib/kolla/venv/bin/pip install --cert /etc/pki/tls/cert.pem git+https://github.com/stackhpc/stackhpc-inspector-plugins@1.3.0
  neutron_server_footer: |
    RUN /var/lib/kolla/venv/bin/pip install --cert /etc/pki/tls/cert.pem git+https://github.com/RSE-Cambridge/networking-generic-switch@cumulus-ussuri -c https://releases.openstack.org/constraints/upper/ussuri
    RUN /var/lib/kolla/venv/bin/pip install --cert /etc/pki/tls/cert.pem etcd3gw
  prometheus_server_repository_version: |
    # Avoid the pain of porting 1.x rules and migrating data to 2.x
    ARG prometheus_version='2.8.0'
  prometheus_cadvisor_repository_version: |
    ENV prometheus_cadvisor_version=0.35.0
  ironic_inspector_footer: |
    # Install our custom inspector plugins.
    RUN /var/lib/kolla/venv/bin/pip install --cert /etc/pki/tls/cert.pem  git+https://github.com/stackhpc/stackhpc-inspector-plugins@1.3.0
  nova_base_footer: |
    RUN /var/lib/kolla/venv/bin/pip install --prefix /var/lib/kolla/venv --cert /etc/pki/tls/cert.pem -U --no-deps git+https://github.com/stackhpc/nova.git@scientific-openstack/ussuri -c https://releases.openstack.org/constraints/upper/ussuri

# Dict mapping image customization variable names to their values.
# Each variable takes the form:
# <image name>_<customization>_<operation>
# Hyphens in the image name are replaced with underscores. The customization is
# most commonly packages. The operation should be one of override, append or
# remove. The value should be a list.
kolla_build_customizations:
  bifrost_packages_append:
    - 'jq'
  keystone_packages_append:
    # Allow custom packages to be installed via pip.
    # Allow manual install of openidc for federation
    - 'jansson-devel'
    - 'openssl-devel'
    - 'hiredis'
  neutron_server_packages_append:
    # Allow custom packages to be installed via pip.
    - 'gcc'
    - 'python3-devel'

###############################################################################
# Dummy variable to allow Ansible to accept this file.
workaround_ansible_issue_8743: yes
