---
###############################################################################
# Global configuration.

switch_config_nested:
  - "{{ switch_config_hostname }}"
  - "{{ switch_config_mgmt }}"
  - "{{ switch_config_spanning_tree }}"
  - "{{ switch_config_bfd }}"
  - "{{ switch_config_mtu }}"

switch_config_mtu:
  - default mtu 1532

###############################################################################
# Interface configuration.

switch_interface_config_vlans_template: |-
  vlan {{ public_net_name | net_vlan }}:
    description: public
    config:
      - no shutdown
  vlan {{ provision_oc_untagged_vlan }}:
    description: overcloud-provisioning
    config:
      - no shutdown
  vlan {{ provision_wl_net_name | net_vlan }}:
    description: workload-provisioning
    config:
      - no shutdown
  vlan {{ oob_oc_net_name | net_vlan }}:
    description: overcloud-iDRAC
    config:
      - no shutdown
  vlan {{ oob_wl_net_name | net_vlan }}:
    description: workload-iDRAC
    config:
      - no shutdown
  vlan {{ mgmt_lustre_vlan }}:
    description: lustre-iDRAC
    config:
      - no shutdown
  vlan {{ switch_mgmt_vlan }}:
    description: switch-management
    config:
      - no shutdown
  vlan {{ lustre_storage_vlan }}:
    description: Lustre-storage
    config:
      - no shutdown
      - mtu {{ lustre_storage_mtu }}

switch_interface_config_ethernet:
  Ethernet 1/1/52:
    description: Uplink
    config: "{{ switch_interface_config_uplink }}"

###############################################################################
# Interface variables and templates.

# Overcloud iDRAC/provisioning ports
switch_interface_config_overcloud_idrac:
  - no shutdown
  - switchport mode trunk
  - switchport access vlan {{ provision_oc_untagged_vlan }}
  - switchport trunk allowed vlan {{ oob_oc_net_name | net_vlan }}
  - spanning-tree port type edge

# Workload iDRAC/provisioning ports
switch_interface_config_workload_idrac:
  - no shutdown
  - flowcontrol receive on
  - switchport mode trunk
  - switchport trunk allowed vlan {{ oob_wl_net_name | net_vlan }}
  - spanning-tree port type edge

# Lustre iDRAC/provisioning ports
switch_interface_config_lustre_idrac:
  - no shutdown
  - flowcontrol receive on
  - switchport mode access
  - switchport access vlan {{ mgmt_lustre_vlan }}
  - spanning-tree port type edge

# Proxmox iDRAC/provisioning ports
switch_interface_config_proxmox:
  - no shutdown
  - flowcontrol receive on
  - switchport mode trunk
  - switchport access vlan {{ provision_wl_net_name | net_vlan }}
  - switchport trunk allowed vlan {{ switch_mgmt_proxmox_trunk_vlans | unique | join(',') }}
  - spanning-tree port type edge

# Overcloud dedicated iDRAC ports
switch_interface_config_overcloud_idrac_dedicated:
  - no shutdown
  - switchport mode access
  - switchport access vlan {{ oob_oc_net_name | net_vlan }}
  - spanning-tree port type edge

# Controller dedicated provisioning ports
switch_interface_config_controller_provision_dedicated:
  - no shutdown
  - switchport mode trunk
  - switchport access vlan {{ provision_oc_untagged_vlan }}
  # The controllers use their shared 1G NIC for connecting Neutron to physnet2.
  - switchport trunk allowed vlan {{ lustre_storage_vlan }}
  - spanning-tree port type edge

# Uplink VLT
switch_interface_config_uplink:
  - no shutdown
  - mtu {{ switch_fabric_mtu }}
  - flowcontrol receive on
  - switchport mode trunk
  - switchport trunk allowed vlan {{ switch_mgmt_uplink_trunk_vlans | unique | join(',') }}

# VLANs to trunk to Proxmox nodes.
switch_mgmt_proxmox_trunk_vlans:
  - "{{ public_net_name | net_vlan }}"
  - "{{ provision_oc_untagged_vlan }}"
  - "{{ oob_oc_net_name | net_vlan }}"
  - "{{ oob_wl_net_name | net_vlan }}"
  - "{{ mgmt_lustre_vlan }}"
