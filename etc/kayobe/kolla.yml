---
# Kayobe Kolla configuration.

###############################################################################
# Kolla installation.

# Type of Kolla control installation. One of 'binary' or 'source'.
kolla_ctl_install_type: source

# Path to directory for kolla source code checkout.
#kolla_source_path:

# URL of Kolla source code repository if type is 'source'.
kolla_source_url: https://github.com/RSE-Cambridge/kolla

# Version (branch, tag, etc.) of Kolla source code repository if type is
# 'source'. Default is {{ openstack_branch }}.
kolla_source_version: cumulus/11.0.0.2

# Path to virtualenv in which to install kolla.
#kolla_venv:

# Path in which to generate kolla configuration.
#kolla_build_config_path:

###############################################################################
# Kolla-ansible installation.

# Type of Kolla-ansible control installation. One of 'binary' or 'source'.
# Default is 'source'.
kolla_ansible_ctl_install_type: source

# Path to directory for kolla-ansible source code checkout.
# Default is $KOLLA_SOURCE_PATH, or $PWD/src/kolla-ansible if
# $KOLLA_SOURCE_PATH is not set.
#kolla_ansible_source_path:

# URL of Kolla Ansible source code repository if type is 'source'. Default is
# https://opendev.org/openstack/kolla-ansible.
kolla_ansible_source_url: https://github.com/RSE-Cambridge/kolla-ansible

# Version (branch, tag, etc.) of Kolla Ansible source code repository if type
# is 'source'. Default is {{ openstack_branch }}.
kolla_ansible_source_version: cumulus/11.0.0.5

# Path to virtualenv in which to install kolla-ansible. Default is
# $KOLLA_VENV_PATH or $PWD/venvs/kolla-ansible if $KOLLA_VENV_PATH is not set.
#kolla_ansible_venv:

# Extra requirements to install inside the kolla-ansible virtualenv.
#kolla_ansible_venv_extra_requirements:

# Path to Kolla-ansible configuration directory. Default is $KOLLA_CONFIG_PATH
# or /etc/kolla if $KOLLA_CONFIG_PATH is not set.
#kolla_config_path:

# Path to Kolla-ansible node custom configuration directory. Default is
# {{ kolla_config_path }}/config.
#kolla_node_custom_config_path:

###############################################################################
# Kolla configuration.

# Kolla base container image distribution. Default is 'centos'.
#kolla_base_distro:

# Kolla container image type: binary or source. Default is 'binary'.
kolla_install_type: source

# URL of docker registry to use for Kolla images. Default is not set, in which
# case Dockerhub will be used.
kolla_docker_registry: '{{ docker_registry }}'

# Docker namespace to use for Kolla images. Default is 'kolla'.
kolla_docker_namespace: scientific-openstack/infrastructure/kayobe-config

# Username to use to access a docker registry. Default is not set, in which
# case the registry will be used without authentication.
#kolla_docker_registry_username:

# Password to use to access a docker registry. Default is not set, in which
# case the registry will be used without authentication.
#kolla_docker_registry_password:

# Kolla OpenStack release version. This should be a Docker image tag.
# Default is {{ openstack_release }}.
kolla_openstack_release: 11.0.0.2-3

# Docker tag applied to built container images. Default is
# {{ kolla_openstack_release }}.
kolla_tag: >-
        {{ openstack_release }}-{{- lookup('env', 'KOLLA_IMAGE_VERSION ')
        | default(ansible_facts.date_time.iso8601_basic_short, true) -}}
        {{ ('-' ~ kolla_tag_suffix) if kolla_tag_suffix is defined else '' }}

# Dict mapping names of sources to their definitions for
# kolla_install_type=source. See kolla.common.config for details.
# Example:
# kolla_sources:
#   ironic-base:
#     type: git
#     location: https://github.com/openstack/ironic
#     reference: master
kolla_sources:
  ironic-inspector-additions-stackhpc-inspector-plugins:
    # Install our custom inspector plugins.
    type: git
    location: https://github.com/stackhpc/stackhpc-inspector-plugins.git
    reference: 1.3.0
  neutron-base-plugin-networking-generic-switch:
    type: git
    location: https://github.com/stackhpc/networking-generic-switch
    reference: stackhpc/victoria-batching
  nova-base:
    type: git
    location: https://github.com/stackhpc/nova
    reference: stackhpc/victora-ironic-rebalance

###############################################################################
# Kolla image build configuration.

# List of repositories for CentOS Stream.
stackhpc_centos_stream_repos:
  - url: "{{ stackhpc_repo_centos_stream_baseos_url }}"
    file: "CentOS-Stream-BaseOS.repo"
  - url: "{{ stackhpc_repo_centos_stream_appstream_url }}"
    file: "CentOS-Stream-AppStream.repo"
  - url: "{{ stackhpc_repo_centos_stream_extras_url }}"
    file: "CentOS-Stream-Extras.repo"

# List of repositories for EPEL.
stackhpc_epel_repos:
  - url: "{{ stackhpc_repo_epel_url }}"
    file: "epel.repo"
  - url: "{{ stackhpc_repo_epel_modular_url }}"
    file: "epel-modular.repo"

# List of additional CentOS Stream repositories.
stackhpc_centos_additional_repos:
  # Snapshots install broken repo file, so hardcode to one that works.
  - url: "{{ stackhpc_repo_centos_storage_ceph_nautilus_url }}"
    file: CentOS-Ceph-Nautilus.repo
  - url: "{{ stackhpc_repo_centos_stream_powertools_url }}"
    file: "CentOS-Stream-PowerTools.repo"
  - url: "{{ stackhpc_repo_centos_opstools_url }}"
    file: "CentOS-OpsTools.repo"

# List of third-party repositories.
stackhpc_third_party_repos: []

# Dict mapping Jinja2 block names in kolla's Docker images to their contents.
kolla_build_blocks:
  base_header: |
    RUN \
    {% for repo in stackhpc_centos_stream_repos %}
        sed -i -e 's/^\(mirrorlist *=.*\)/#\1/g' \
               -e 's/^[# ]*\(baseurl *=.*\)/#\1/g' \
               -e '/#baseurl.*/a baseurl={{ repo.url }}' /etc/yum.repos.d/{{ repo.file }}{% if not loop.last %} && \
    {% endif %}
    {% endfor %}
  base_centos_repo_overrides_post_yum: |
    {# fixme #}
        && \
    {% for repo in stackhpc_centos_stream_repos + stackhpc_epel_repos + stackhpc_centos_additional_repos + stackhpc_third_party_repos %}
        sed -i -e 's/^\(mirrorlist *=.*\)/#\1/g' \
               -e 's/^[# ]*\(baseurl *=.*\)/#\1/g' \
               -e '/#baseurl.*/a baseurl={{ repo.url }}' /etc/yum.repos.d/{{ repo.file }}{% if not loop.last %} &&{% endif %} \
    {% endfor %}
  grafana_plugins_install: |
    RUN grafana-cli plugins install vonage-status-panel
  ironic_inspector_header: |
    ADD additions-archive /
  prometheus_server_repository_version: |
    # Avoid the pain of porting 1.x rules and migrating data to 2.x
    ARG prometheus_version='2.35.0'
  prometheus_cadvisor_repository_version: |
    ARG prometheus_cadvisor_version=0.40.0
    ARG prometheus_cadvisor_sha256sum='8e3df91eee70c72ac3f3184b9fab1229b037c2e850ff1593103b2bd9028c57c0'
  prometheus_alertmanager_repository_version: |
    ARG prometheus_alertmanager_version='0.24.0'
  node_exporter_repository_version: |
    ARG node_exporter_version='1.3.1'
  prometheus_memcached_exporter_repository_version: |
    ARG memcached_exporter_version='0.9.0'
  haproxy_exporter_repository_version: |
    ARG haproxy_exporter_version='0.13.0'
  mysqld_exporter_repository_version: |
    ARG mysqld_exporter_version='0.13.0'
  prometheus_blackbox_exporter_repository_version: |
    ARG blackbox_exporter_version='0.19.0'

# Dict mapping image customization variable names to their values.
# Each variable takes the form:
# <image name>_<customization>_<operation>
# Hyphens in the image name are replaced with underscores. The customization is
# most commonly packages. The operation should be one of override, append or
# remove. The value should be a list.
kolla_build_customizations:
  bifrost_packages_append:
    - 'jq'
  keystone_packages_append:
    # Allow custom packages to be installed via pip.
    # Allow manual install of openidc for federation
    - 'jansson-devel'
    - 'openssl-devel'
    - 'hiredis'
  neutron_server_packages_append:
    # Allow custom packages to be installed via pip.
    - 'gcc'
    - 'python3-devel'
  bifrost_pip_packages_append:
    - git+https://github.com/stackhpc/stackhpc-inspector-plugins@1.3.0
  neutron_server_pip_packages_append:
    - etcd3gw
  ironic_inspector_pip_packages_append:
    - /additions/*

###############################################################################
# Kolla-ansible inventory configuration.

# Full custom seed inventory contents.
#kolla_seed_inventory_custom:

# List of names of host variables to pass through from kayobe hosts to
# the kolla-ansible seed host, if set. See also
# kolla_seed_inventory_pass_through_host_vars_map.
#kolla_seed_inventory_pass_through_host_vars:

# Dict mapping names of variables in
# kolla_seed_inventory_pass_through_host_vars to the variable to use in
# kolla-ansible. If a variable name is not in this mapping the kayobe name is
# used.
#kolla_seed_inventory_pass_through_host_vars_map:

# Custom overcloud inventory containing a mapping from top level groups to
# hosts.
#kolla_overcloud_inventory_custom_top_level:

# Custom overcloud inventory containing a mapping from components to top level
# groups.
#kolla_overcloud_inventory_custom_components:
kolla_overcloud_inventory_custom_components: "{{ lookup('template', kayobe_config_path\
  \ ~ '/kolla/inventory/overcloud-components.j2') }}"

# Custom overcloud inventory containing a mapping from services to components.
kolla_overcloud_inventory_custom_services: "{{ lookup('template', kayobe_config_path\
  \ ~ '/kolla/inventory/overcloud-services.j2') }}"

# Full custom overcloud inventory contents. By default this will be the
# concatenation of the top level, component, and service inventories.
#kolla_overcloud_inventory_custom:

# Dict mapping from kolla-ansible groups to kayobe groups and variables. Each
# item is a dict with the following items:
# * groups: A list of kayobe ansible groups to map to this kolla-ansible group.
# * vars: A dict mapping variable names to values for hosts in this
#         kolla-ansible group.
#kolla_overcloud_inventory_top_level_group_map:

# List of names of top level kolla-ansible groups. Any of these groups which
# have no hosts mapped to them will be provided with an empty group definition.
#kolla_overcloud_inventory_kolla_top_level_groups:

# List of names of host variables to pass through from kayobe hosts to
# kolla-ansible hosts, if set. See also
# kolla_overcloud_inventory_pass_through_host_vars_map.
#kolla_overcloud_inventory_pass_through_host_vars:

# Dict mapping names of variables in
# kolla_overcloud_inventory_pass_through_host_vars to the variable to use in
# kolla-ansible. If a variable name is not in this mapping the kayobe name is
# used.
#kolla_overcloud_inventory_pass_through_host_vars_map:

###############################################################################
# Kolla-ansible configuration.

# Virtualenv directory where Kolla-ansible's ansible modules will execute
# remotely on the target nodes. If None, no virtualenv will be used.
#kolla_ansible_target_venv:

# Whether TLS is enabled for the external API endpoints. Default is 'no'.
#kolla_enable_tls_external:

# Whether TLS is enabled for the internal API endpoints. Default is 'no'.
#kolla_enable_tls_internal:

# Whether debug logging is enabled. Default is 'false'.
#kolla_openstack_logging_debug:

# Upper constraints file for installation of Kolla.
# Default value is {{ pip_upper_constraints_file }}.
#kolla_upper_constraints_file:

# User account to use for Kolla SSH access. Default is 'kolla'.
#kolla_ansible_user:

# Primary group of Kolla SSH user. Default is 'kolla'.
#kolla_ansible_group:

# Whether to use privilege escalation for all operations performed via Kolla
# Ansible. Default is 'false'.
#kolla_ansible_become:

# Whether to create a user account, configure passwordless sudo and authorise
# an SSH key for Kolla Ansible. Default is 'true'.
#kolla_ansible_create_user:

###############################################################################
# Kolla feature flag configuration.

#kolla_enable_aodh:
kolla_enable_barbican: true
#kolla_enable_blazar:
#kolla_enable_cadf_notifications:
kolla_enable_caso: true
#kolla_enable_ceilometer:
#kolla_enable_ceilometer_ipmi:
#kolla_enable_cells:
#kolla_enable_central_logging:
kolla_enable_central_logging: true
kolla_enable_chrony: false
kolla_enable_cinder: '{{ scientific_openstack_trait_ceph }}'
#kolla_enable_cinder_backend_hnas_nfs:
#kolla_enable_cinder_backend_iscsi:
#kolla_enable_cinder_backend_lvm:
#kolla_enable_cinder_backend_nfs:
#kolla_enable_cinder_backend_quobyte:
#kolla_enable_cinder_backend_zfssa_iscsi:
#kolla_enable_cinder_backup:
#kolla_enable_cloudkitty:
#kolla_enable_collectd:
#kolla_enable_cyborg:
kolla_enable_designate: true
#kolla_enable_destroy_images:
#kolla_enable_elasticsearch:
#kolla_enable_etcd:
#kolla_enable_fluentd:
#kolla_enable_freezer:
#kolla_enable_glance:
#kolla_enable_gnocchi:
kolla_enable_grafana: true
#kolla_enable_haproxy:
kolla_enable_heat: true
kolla_enable_horizon: true
#kolla_enable_horizon_blazar:
#kolla_enable_horizon_cloudkitty:
#kolla_enable_horizon_congress:
#kolla_enable_horizon_designate:
#kolla_enable_horizon_freezer:
#kolla_enable_horizon_fwaas:
#kolla_enable_horizon_heat:
#kolla_enable_horizon_ironic:
#kolla_enable_horizon_karbor:
#kolla_enable_horizon_magnum:
#kolla_enable_horizon_manila:
#kolla_enable_horizon_masakari:
#kolla_enable_horizon_mistral:
#kolla_enable_horizon_murano:
#kolla_enable_horizon_neutron_vpnaas:
#kolla_enable_horizon_octavia:
#kolla_enable_horizon_qinling:
#kolla_enable_horizon_sahara:
#kolla_enable_horizon_searchlight:
#kolla_enable_horizon_senlin:
#kolla_enable_horizon_solum:
#kolla_enable_horizon_tacker:
#kolla_enable_horizon_trove:
#kolla_enable_horizon_vitrage:
#kolla_enable_horizon_watcher:
#kolla_enable_horizon_zun:
#kolla_enable_hyperv:
#kolla_enable_influxdb:
kolla_enable_ironic: false
#kolla_enable_ironic_ipxe: true
#kolla_enable_ironic_neutron_agent:
#kolla_enable_ironic_pxe_uefi:
#kolla_enable_iscsid:
#kolla_enable_kafka:
#kolla_enable_karbor:
#kolla_enable_keepalived:
#kolla_enable_keystone:
#kolla_enable_kibana:
#kolla_enable_kuryr:
kolla_enable_magnum: true
kolla_enable_manila: '{{ scientific_openstack_trait_ceph }}'
kolla_enable_manila_backend_cephfs_native: '{{ scientific_openstack_trait_ceph }}'
#kolla_enable_manila_backend_cephfs_nfs:
#kolla_enable_manila_backend_generic:
#kolla_enable_manila_backend_hnas:
kolla_enable_mariabackup: true
#kolla_enable_mariadb:
#kolla_enable_masakari:
#kolla_enable_memcached:
#kolla_enable_mistral:
#kolla_enable_monasca:
#kolla_enable_mongodb:
#kolla_enable_multipathd:
#kolla_enable_murano:
#kolla_enable_neutron:
kolla_enable_neutron_agent_ha: true
#kolla_enable_neutron_bgp_dragent:
#kolla_enable_neutron_dvr:
#kolla_enable_neutron_fwaas:
#kolla_enable_neutron_infoblox_ipam_agent:
#kolla_enable_neutron_metering:
#kolla_enable_neutron_mlnx:
#kolla_enable_neutron_port_forwarding:
kolla_enable_neutron_provider_networks: true
#kolla_enable_neutron_qos:
#kolla_enable_neutron_segments:
#kolla_enable_neutron_sfc:
#kolla_enable_neutron_sriov:
#kolla_enable_neutron_vpnaas:
#kolla_enable_nova:
kolla_enable_nova_libvirt_container: "{{ ansible_facts.os_family == 'RedHat' and ansible_facts.distribution_major_version | int == 7 }}"
#kolla_enable_nova_serialconsole_proxy:
#kolla_enable_nova_ssh:
kolla_enable_octavia: true
#kolla_enable_onos:
#kolla_enable_opendaylight:
#kolla_enable_openstack_core:
#kolla_enable_openvswitch:
#kolla_enable_osprofiler:
#kolla_enable_outward_rabbitmq:
#kolla_enable_ovs_dpdk:
#kolla_enable_panko:
#kolla_enable_placement:
kolla_enable_prometheus: true
#kolla_enable_qdrouterd:
#kolla_enable_qinling:
#kolla_enable_rabbitmq:
#kolla_enable_rally:
#kolla_enable_redis:
#kolla_enable_sahara:
#kolla_enable_searchlight:
#kolla_enable_senlin:
#kolla_enable_skydive:
#kolla_enable_solum:
#kolla_enable_storm:
#kolla_enable_swift:
#kolla_enable_swift_s3api:
#kolla_enable_tacker:
#kolla_enable_telegraf:
#kolla_enable_tempest:
#kolla_enable_trove:
#kolla_enable_trove_singletenant:
#kolla_enable_vitrage:
#kolla_enable_vmtp:
#kolla_enable_watcher:
#kolla_enable_zookeeper:
#kolla_enable_zun:
###############################################################################
# Kolla custom config options.

# Override the the list of paths that are searched when looking for kolla custom
# config. The default is to search the the environment specific path, if such a
# path exists, and then shared config path. Files in the environment specific
# directory override those found in the common configuration if the relative
# path of the file is identical. This behaviour can be adjusted using the
# configuration options below. For example, it is possible to merge yaml files
# with the kolla_openstack_custom_config_merge_yml_globs variable.
#kolla_extra_config_paths:

# Default value for kolla_openstack_custom_config_include_globs.
#kolla_openstack_custom_config_include_globs_default:

# Extra items to add to kolla_openstack_custom_config_include_globs_default
# to produce kolla_openstack_custom_config_include_globs.
#kolla_openstack_custom_config_include_globs_extra:

# List of dictionaries with the following keys:
#   glob: a glob pattern. Any files matching this pattern will be copied to the
#         the kolla custom config directory
#   enabled: boolean to disable the glob.
#kolla_openstack_custom_config_include_globs:

# Default value for kolla_openstack_custom_config_template_exclude_globs.
#kolla_openstack_custom_config_template_exclude_globs_default:

# Extra items to add to kolla_openstack_custom_config_template_exclude_globs_default
# to produce kolla_openstack_custom_config_template_exclude_globs.
#kolla_openstack_custom_config_template_exclude_globs_extra:

# List of globs. Any files matching these globs will not be templated.
#kolla_openstack_custom_config_template_exclude_globs:

# Default value for openstack_custom_config_merge_ini_globs.
#kolla_openstack_custom_config_merge_ini_globs_default:

# Extra items to add to kolla_openstack_custom_config_merge_ini_globs_default
# to produce openstack_custom_config_merge_ini_globs.
#kolla_openstack_custom_config_merge_ini_globs_extra:

# List of dictionaries with following keys:
#   glob: A glob pattern. Any files matching this pattern will be merged using
#         the merge_configs filter.
# E.g:
#   kolla_openstack_custom_config_merge_ini_globs:
#     - glob: "**/*.ini"
#kolla_openstack_custom_config_merge_ini_globs:

# Default value for openstack_custom_config_merge_yml_globs.
#kolla_openstack_custom_config_merge_yml_globs_default:

# Extra items to add to kolla_openstack_custom_config_merge_yml_globs_default
# to produce openstack_custom_config_merge_yml_globs.
#kolla_openstack_custom_config_merge_yml_globs_extra:

# List of dictionaries with following keys:
#   glob: A glob pattern. Any files matching this pattern will be merged using
#         the merge_yaml ansible filter.
# E.g:
# kolla_openstack_custom_config_merge_yml_globs:
#   - glob: "**/*.yml"
#     merge_lists: false
#kolla_openstack_custom_config_merge_yml_globs:

###############################################################################
# Passwords and credentials.

# Dictionary containing default custom passwords to add or override in the
# Kolla passwords file.
#kolla_ansible_default_custom_passwords:

# Dictionary containing custom passwords to add or override in the Kolla
# passwords file.
kolla_ansible_custom_passwords_extra:
  libvirt_sasl_password: "{{ secrets_libvirt_sasl_password }}"
  docker_registry_password: "{{ kolla_docker_registry_password }}"

# Extend the defaults with the above extra passwords
# TODO: might be able to drop this in Victoria
kolla_ansible_custom_passwords: >-
  {{ kolla_ansible_default_custom_passwords |
     combine(kolla_ansible_custom_passwords_extra) }}

###############################################################################
# TLS certificate bundle management

# External API certificate bundle.
#
# When kolla_enable_tls_external is true, this should contain an X.509
# certificate bundle for the external API.
#
# Note that this should be formatted as a literal style block scalar.
#
# NOTE: kolla_tls_cert has been renamed to kolla_external_tls_cert. Support for
# the deprecated name kolla_tls_cert will be removed in a future release.
#kolla_external_tls_cert:

# Path to a CA certificate file to use for the OS_CACERT environment variable
# in public-openrc.sh file when TLS is enabled, instead of Kolla-Ansible's
# default.
#kolla_external_fqdn_cacert:

# Internal API certificate bundle.
#
# When kolla_enable_tls_internal is true, this should contain an X.509
# certificate bundle for the internal API.
#
# Note that this should be formatted as a literal style block scalar.
#kolla_internal_tls_cert:

# Path to a CA certificate file to use for the OS_CACERT environment variable
# in admin-openrc.sh file when TLS is enabled, instead of Kolla-Ansible's
# default.
#kolla_internal_fqdn_cacert:

###############################################################################
# Dummy variable to allow Ansible to accept this file.
workaround_ansible_issue_8743: yes
