# https://awesome-prometheus-alerts.grep.to/rules#host-and-hardware-1

{% raw %}

groups:
- name: Node
  rules:

  - alert: LowDiskSpace
    expr: ( ( node_filesystem_free_bytes - node_filesystem_avail_bytes ) / node_filesystem_free_bytes ) * 100 >= 80
    for: 1m
    labels:
      severity: alert
    annotations:
      summary: "Prometheus exporter at {{ $labels.instance }} reports low disk space"
      description: "{{ $labels.device }} is {{ $value }}% full."

  - alert: LowMemory
    expr: (node_memory_MemAvailable_bytes / 1024^3) < {% endraw %}{{ alertmanager_low_memory_threshold_gib }}{% raw %}
    for: 1m
    labels:
      severity: alert
    annotations:
      summary: "Prometheus exporter at {{ $labels.instance }} reports low memory"
      description: "Available memory is {{ $value }}."

  - alert: HostOomKillDetected
    expr: increase(node_vmstat_oom_kill[5m]) > 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Host OOM kill detected (instance {{ $labels.instance }})"
      description: "OOM kill detected"

  - alert: Overheating
    expr: node_hwmon_temp_celsius >= node_hwmon_temp_max_celsius
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "Prometheus exporter at {{ $labels.instance }} reports overheating"
      description: "Sensor {{ $labels.chip }} reports {{ $value }} degrees celcius."

  - alert: HostNodeOvertemperatureAlarm
    expr: node_hwmon_temp_crit_alarm_celsius == 1
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Host node overtemperature alarm (instance {{ $labels.instance }})"
      description: "Physical node temperature alarm triggered"

  - alert: InstanceDown
    expr: up{job="node"} == 0
    for: 1m
    labels:
      severity: alert
    annotations:
      summary: "Instance {{$labels.instance}} down"
      description: "{{$labels.instance}} has been down for more than 5 minutes."

  - alert: HostEdacCorrectableErrorsDetected
    expr: increase(node_edac_correctable_errors_total[5m]) > 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Host EDAC Correctable Errors detected (instance {{ $labels.instance }})"
      description: "{{ $labels.instance }} has had {{ printf \"%.0f\" $value }} correctable memory errors reported by EDAC in the last 5 minutes."

  - alert: HostEdacUncorrectableErrorsDetected
    expr: node_edac_uncorrectable_errors_total > 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Host EDAC Uncorrectable Errors detected (instance {{ $labels.instance }})"
      description: "{{ $labels.instance }} has had {{ printf \"%.0f\" $value }} uncorrectable memory errors reported by EDAC in the last 5 minutes."

  - alert: HostClockSkew
    expr: (node_timex_offset_seconds > 0.05 and deriv(node_timex_offset_seconds[5m]) >= 0) or (node_timex_offset_seconds < -0.05 and deriv(node_timex_offset_seconds[5m]) <= 0)
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: Host clock skew (instance {{ $labels.instance }})
      description: "Clock skew detected. Clock is out of sync. Ensure NTP is configured correctly on this host."

  - alert: HostClockNotSynchronising
    expr: min_over_time(node_timex_sync_status[1m]) == 0 and node_timex_maxerror_seconds >= 16
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: Host clock not synchronising (instance {{ $labels.instance }})
      description: "Clock not synchronising. Ensure NTP is configured on this host."

  - alert: HostConntrackLimit
    expr: node_nf_conntrack_entries / node_nf_conntrack_entries_limit > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: Host conntrack limit (instance {{ $labels.instance }})
      description: "The number of conntrack is approaching limit"
{% endraw %}
